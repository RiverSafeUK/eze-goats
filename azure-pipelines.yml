# Eze Starter pipeline
# Minimal pipeline that runs eze tool
# https://aka.ms/yaml

trigger:
- main

pool:
  vmImage: ubuntu-latest

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.8'

# https://docs.microsoft.com/azure/devops/pipelines/tasks/utility/command-line
- script: |
    docker pull riversafe/eze-cli:latest
  displayName: 'Pull eze docker'

- script: |
    cd goat-node
    docker run --rm -e "EZE_APIKEY=$(EZE_APIKEY)" -e "BUILD_SOURCEBRANCHNAME=$(BUILD_SOURCEBRANCHNAME)" -e "BUILD_REPOSITORY_URI=$(BUILD_REPOSITORY_URI)" -v "$(pwd)":/data riversafe/eze-cli test -s ci
  env:
    EZE_APIKEY: $(EZE_APIKEY)
  displayName: 'Run Eze against Node Goat'

- script: |
    cd goat-python
    docker run --rm -e "EZE_APIKEY=$(EZE_APIKEY)" -e "BUILD_SOURCEBRANCHNAME=$(BUILD_SOURCEBRANCHNAME)" -e "BUILD_REPOSITORY_URI=$(BUILD_REPOSITORY_URI)" -v "$(pwd)":/data riversafe/eze-cli test -s ci
  env:
    EZE_APIKEY: $(EZE_APIKEY)
  displayName: 'Run Eze against Python Goat'

- script: |
    cd goat-java
    chmod +777 ./
    docker run --rm -e "EZE_APIKEY=$(EZE_APIKEY)" -e "BUILD_SOURCEBRANCHNAME=$(BUILD_SOURCEBRANCHNAME)" -e "BUILD_REPOSITORY_URI=$(BUILD_REPOSITORY_URI)" -v "$(pwd)":/data riversafe/eze-cli test -s ci --debug
  env:
    EZE_APIKEY: $(EZE_APIKEY)
  displayName: 'Run Eze against Java Goat'

- script: |
    cd goat-secrets
    docker run --rm -e "EZE_APIKEY=$(EZE_APIKEY)" -e "BUILD_SOURCEBRANCHNAME=$(BUILD_SOURCEBRANCHNAME)" -e "BUILD_REPOSITORY_URI=$(BUILD_REPOSITORY_URI)" -v "$(pwd)":/data riversafe/eze-cli test -s ci
  env:
    EZE_APIKEY: $(EZE_APIKEY)
  displayName: 'Run Eze against Secrets Goat'